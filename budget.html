<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Today_Money_Search</title>
    <script src="https://unpkg.com/dexie@3.2.3/dist/dexie.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        /* ğŸ¨ ë””ìì¸ í†µì¼ ê¸°ì¤€: ë¸”ë£¨ ê³„ì—´ */
        :root {
            --bg-light: #f7f9fc;
            --main-accent: #4a90e2; /* ë©”ì¸ ìƒ‰ìƒ: ë°ì€ íŒŒë‘ */
            --text-color: #333333;
            --card-background: #ffffff;
            --shadow-light: 0 4px 10px rgba(0, 0, 0, 0.08);
            /* ê°€ê³„ë¶€ ì „ìš© ìƒ‰ìƒ */
            --income-color: #32a852;
            /* ìˆ˜ì…: ë…¹ìƒ‰ */
            --expense-color: #ea4335;
            /* ì§€ì¶œ: ë¹¨ê°„ìƒ‰ */
            --table-header: #f0f8ff;
            /* ì—‘ì…€ í—¤ë” ë°°ê²½ìƒ‰ */
        }

        body {
            /* í°íŠ¸ í¬ê¸° í†µì¼: ê¸°ë³¸ í°íŠ¸ë¥¼ 16pxë¡œ í™•ëŒ€ */
            font-size: 16px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-light); 
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            justify-content: center;
        }
        
        /* ğŸ“ ê°€ë¡œí­ í†µì¼ ê¸°ì¤€ ì ìš© (max-width: 480px) */
        .container {
            width: 100%;
            max-width: 480px; 
            padding: 20px;
        }

        /* ë©”ì¸ ì œëª© (2.0em, Boldë¡œ í™•ëŒ€) */
        h2 {
            text-align: center;
            color: var(--main-accent); 
            margin: 10px 0 20px;
            font-size: 2.0em; 
            font-weight: 600;
        }
        
        /* ì„¹ì…˜ ì œëª© ìŠ¤íƒ€ì¼ í†µì¼ (1.6emìœ¼ë¡œ í™•ëŒ€) */
        .section-header {
            border-bottom: 2px solid var(--main-accent);
            padding-bottom: 10px;
            margin-top: 30px;
            margin-bottom: 20px;
            font-size: 1.6em;
            color: var(--text-color);
            font-weight: bold;
            text-align: center;
        }

        /* ì¹´ë“œ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        .card {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 0 2px var(--main-accent), var(--shadow-light); 
            margin-bottom: 30px;
        }

        /* ì”ì•¡ í‘œì‹œ ì¹´ë“œ */
        .balance-card {
            text-align: center;
        }

        .balance-card h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.3em; /* í°íŠ¸ í™•ëŒ€ */
            font-weight: bold;
            color: var(--text-color);
            border-bottom: 1px solid var(--main-accent); 
            padding-bottom: 10px;
        }

        /* ì”ì•¡ í…ìŠ¤íŠ¸ (2.2emìœ¼ë¡œ í¬ê²Œ ê°•ì¡°) */
        .total-text { font-size: 2.2em;
            font-weight: bold; color: var(--main-accent); }
        .balance-label { font-size: 0.9em;
            }

        /* ì…ë ¥ í¼ ìŠ¤íƒ€ì¼ */
        .input-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        .input-form .full-width { grid-column: 1 / -1;
            }
        /* ë ˆì´ë¸” í°íŠ¸ í™•ëŒ€ */
        .input-group label { display: block;
            margin-bottom: 5px; font-weight: bold; font-size: 1.0em; } 
        /* ì…ë ¥/ì„ íƒ í•„ë“œ í°íŠ¸ í™•ëŒ€ */
        .input-form input, .input-form select, .input-form textarea {
            width: 100%;
            padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 1.0em; outline: none; color: var(--text-color);
            }
        
        /* ì €ì¥ ë²„íŠ¼ */
        #saveBudgetBtn {
            background-color: var(--main-accent);
            color: white;
            padding: 12px 20px; /* íŒ¨ë”© í™•ëŒ€ */
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em; /* í°íŠ¸ í™•ëŒ€ */
            width: 100%;
            transition: background-color 0.2s;
        }
        #saveBudgetBtn:hover { background-color: #3a75c4;
            }

        /* ì›”ê°„ í†µê³„ ë° ê·¸ë˜í”„ */
        #monthlyStats {
            margin-bottom: 30px;
            }
        /* ì›”ê°„ ìš”ì•½ í°íŠ¸ í™•ëŒ€ */
        .monthly-summary {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
            font-size: 1.1em;
            }
        .monthly-summary .income-text { color: var(--income-color);
            }
        .monthly-summary .expense-text { color: var(--expense-color);
            }
        .monthly-summary .balance-text { color: var(--main-accent);
            }

        /* --- ì›”ë³„ ì¥ë¶€ í…Œì´ë¸” ìŠ¤íƒ€ì¼ (ì—‘ì…€ ìœ ì‚¬) --- */
        .monthly-ledger-container {
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: var(--shadow-light);
        }

        /* ì›”ë³„ ì œëª© í°íŠ¸ í™•ëŒ€ */
        .month-title {
            background-color: var(--main-accent);
            color: white;
            padding: 12px;
            font-size: 1.3em;
            font-weight: bold;
            text-align: center;
        }
        
        /* ì›”ë³„ ìš”ì•½ í°íŠ¸ í™•ëŒ€ */
        .month-summary {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background-color: var(--table-header);
            border-bottom: 1px solid #ddd;
            font-weight: bold;
            font-size: 1.0em;
        }

        .ledger-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em; /* í…Œì´ë¸” ë‚´ìš© í°íŠ¸ í™•ëŒ€ */
            background-color: white;
        }

        .ledger-table th, .ledger-table td {
            padding: 10px 8px;
            /* íŒ¨ë”© í™•ëŒ€ */
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .ledger-table th {
            background-color: var(--table-header);
            font-weight: bold;
            color: var(--text-color);
        }

        .ledger-table tr:hover {
            background-color: #f5f5f5;
        }

        .ledger-table .expense { color: var(--expense-color);
            font-weight: 500;}
        .ledger-table .income { color: var(--income-color);
            font-weight: 500;}
        
        /* ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í°íŠ¸ í™•ëŒ€ */
        .ledger-table .action-cell button {
            background: none;
            border: none;
            color: var(--main-accent);
            cursor: pointer;
            font-size: 0.9em; 
            margin-left: 5px;
            padding: 0;
        }
        .ledger-table .action-cell button:hover {
            text-decoration: underline;
        }

        /* 5ê°œë…„ í†µê³„ ìŠ¬ë¡¯ ìŠ¤íƒ€ì¼ */
        .year-slot {
            padding: 18px;
            /* íŒ¨ë”© í™•ëŒ€ */
            border: 1px solid var(--main-accent);
            border-radius: 10px;
            text-align: center;
            background-color: var(--table-header);
            margin-bottom: 15px;
        }
        .year-slot strong {
            display: block;
            font-size: 1.3em; /* í°íŠ¸ í™•ëŒ€ */
            margin-bottom: 10px;
            color: var(--main-accent);
        }
        .year-slot p {
            margin: 5px 0;
            font-size: 1.0em; /* í°íŠ¸ í™•ëŒ€ */
        }

        /* ëª©í‘œ ì„¤ì • í˜ì´ì§€ ìŠ¤íƒ€ì¼ (ê°œì„ ë¨: ë³´ê¸°/ìˆ˜ì • ëª¨ë“œ ì „í™˜) */
        #goalMemoInput {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            min-height: 120px;
            /* ë†’ì´ í™•ëŒ€ */
            resize: vertical;
            font-size: 1.0em;
            /* í°íŠ¸ í™•ëŒ€ */
        }
        #goalDisplayArea {
            /* JSì—ì„œ ì„¤ì •ëœ ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì™¸ì— í•„ìš”í•œ ìŠ¤íƒ€ì¼ */
            width: 100%;
        }
        .goal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }
        .goal-actions button {
            padding: 12px 18px;
            /* íŒ¨ë”© í™•ëŒ€ */
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1.0em;
            border: none;
        }
        /* ë²„íŠ¼ ìƒ‰ìƒ */
        #saveGoalBtn { background-color: var(--income-color);
            color: white; }
        #clearGoalBtn { background-color: var(--expense-color); color: white;
            }
        #editGoalBtn { background-color: var(--main-accent); color: white;
            }
        #clearInputBtn { background-color: #999; color: white;
            } /* ì…ë ¥ ì´ˆê¸°í™” ë²„íŠ¼ ìƒ‰ìƒ */
        
        /* ì „ì²´ ì´ˆê¸°í™” ë²„íŠ¼ í°íŠ¸ í™•ëŒ€ */
        .global-actions {
            display: none;
            /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ (JSì—ì„œ 3í˜ì´ì§€ì—ë§Œ ë³´ì´ë„ë¡ ì²˜ë¦¬) */
        }
        .global-actions button {
            background-color: #999;
            color: white;
            padding: 18px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.15em; 
            margin-top: 50px;
            transition: background-color 0.2s;
            width: 100%;
        }
        .global-actions button:hover { background-color: #777;
            }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ë„ í°íŠ¸ í¬ê¸° ë° íŒ¨ë”© ì¡°ì • */
        .modal {
            display: none;
            position: fixed; 
            z-index: 1; 
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto; 
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content { 
            background-color: #fefefe;
            margin: 10% auto; 
            padding: 35px; /* íŒ¨ë”© í™•ëŒ€ */
            border-radius: 15px;
            width: 90%; max-width: 450px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
        }
        .close-btn { 
            color: #aaa;
            float: right; 
            font-size: 28px; font-weight: bold; 
        }
        .close-btn:hover, .close-btn:focus { 
            color: #000;
            text-decoration: none; 
            cursor: pointer; 
        }
        .modal-input-group { margin-bottom: 18px;
            }
        .modal-input-group label { font-size: 1.0em; display: block; margin-bottom: 5px; font-weight: bold;
            }
        .modal-input-group input, .modal-input-group select, .modal-input-group textarea {
            width: 100%;
            padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 1.0em;
            }
        
        .modal-actions button { 
            padding: 12px 18px;
            font-size: 1.0em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.2s;
            margin-right: 10px;
        }
        #modalSaveBtn { background-color: var(--main-accent); color: white;
            }
        #modalDeleteBtn { background-color: var(--expense-color); color: white;
            }
        
        /* í˜ì´ì§€ë„¤ì´ì…˜ ìŠ¤íƒ€ì¼ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 25px;
            font-size: 1.1em;
            font-weight: bold;
        }
        .pagination button {
            background: none;
            border: 2px solid var(--main-accent);
            color: var(--main-accent);
            padding: 8px 15px;
            margin: 0 5px;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 1.1em;
        }
        .pagination button:hover {
            background-color: var(--main-accent);
            color: white;
        }
        .pagination span {
            margin: 0 10px;
        }
        
        /* ì›”ë³„ ì¥ë¶€ í†µê³„ í˜ì´ì§€ìš© í‘œ ìŠ¤íƒ€ì¼ */
        .monthly-stats-table-container {
            border: 1px solid var(--main-accent);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 25px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .month-stat-title-header {
            background-color: var(--main-accent);
            color: white;
            padding: 12px;
            font-size: 1.3em;
            font-weight: bold;
            text-align: center;
        }
        .monthly-stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
            background-color: white;
        }
        .monthly-stats-table th, .monthly-stats-table td {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        .monthly-stats-table th {
            background-color: var(--table-header);
            font-weight: bold;
            color: var(--text-color);
        }
        .monthly-stats-table .memo-cell {
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }

    </style>
</head>
<body>

    <div class="container">
        
        <h2>Today_money_search ğŸ’¸</h2> 

        <div class="pagination">
            <button id="prevPageBtn">â†</button>
            <span id="pageIndicator">í˜ì´ì§€ 1 / 3</span>
            <button id="nextPageBtn">â†’</button>
        </div>
      
        
        <div id="mainViewContainer">

            <div id="recordView" class="page-content">
                
                <div class="balance-card card">
                    <h3>í˜„ì¬ ì”ì•¡ í˜„í™©</h3>
                   
                    <div class="total-item">
                        <div id="currentBalance" class="total-text">0ì›</div>
                        <div class="balance-label" style="margin-top: 10px;">(ì´ ìˆ˜ì… - ì´ ì§€ì¶œ)</div>
                    </div>
                </div>

     
                <div class="input-card card">
                    <h3 class="section-header" style="margin: 0 0 20px 0; border-bottom: 1px solid var(--main-accent);">ìƒˆë¡œìš´ ê¸°ë¡</h3>
                    
                    <div class="input-form">
               
                        
                        <div class="input-group">
                            <label for="budgetDate">ë‚ ì§œ</label>
                            <input type="date" id="budgetDate" required>
      
                        </div>
                        
                        <div class="input-group">
                            <label for="budgetType">ìœ í˜•</label>
    
                            <select id="budgetType" required>
                                <option value="expense">ì§€ì¶œ</option>
                                <option value="income">ìˆ˜ì…</option>
        
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="budgetAmount">ê¸ˆì•¡ (ì›)</label>
 
                            <input type="number" id="budgetAmount" placeholder="ê¸ˆì•¡" required min="1">
                        </div>

                        <div class="input-group">
                   
                            <label for="budgetCategory">ì¹´í…Œê³ ë¦¬</label>
                            <select id="budgetCategory" required>
                                </select>
                        </div>

    
                        <div class="input-group full-width">
                            <label for="budgetMemo">ë©”ëª¨ (ì„ íƒ)</label>
                            <textarea id="budgetMemo" placeholder="ê°„ë‹¨í•œ ë©”ëª¨"></textarea>
                 
                        </div>
                    </div>
                    <button id="saveBudgetBtn">ê¸°ë¡ ì €ì¥</button>
                </div>

                <div class="stats-card card" id="monthlyStats">
                
                    <h3 class="section-header" style="margin: 0 0 10px 0;
                        border-bottom: 1px solid var(--main-accent);">ì›”ê°„ í†µê³„ (í˜„ì¬ ì›” ê¸°ì¤€)</h3>
                    
                    <div class="monthly-summary">
                        <div id="monthlyIncome" class="income-text">ìˆ˜ì…: 0ì›</div>
                        <div 
                            id="monthlyExpense" class="expense-text">ì§€ì¶œ: 0ì›</div>
                        <div id="monthlyBalance" class="balance-text">ì”ì•¡: 0ì›</div>
                    </div>

                    <div style="width: 100%;
                        margin: 15px 0;">
                        <canvas id="dailyExpenseChart"></canvas>
                    </div>
                    
                    <p style="font-size: 0.9em;
                        text-align: center; color: #666;">
                        * ì´ í†µê³„ëŠ” ì—°ê°„ í†µê³„ í˜ì´ì§€ì™€ ë™ê¸°í™”ë©ë‹ˆë‹¤.
                    </p>
                </div>

            </div>
            
            <div id="monthlyLedgerView" class="page-content" style="display: none;">
              
                <h3 class="section-header">ì›”ë³„ ì¥ë¶€ í†µê³„ (í˜ì´ì§€ 2/3)</h3>
                <p style="text-align: center;
                    color: #666; font-size: 0.9em; margin-top: -10px;">
                    * ì›”ë³„ ìƒì„¸ ê¸°ë¡ì€ ê° í–‰ì˜ 'ìƒì„¸ë³´ê¸°' ë²„íŠ¼ì„ í†µí•´ í™•ì¸í•©ë‹ˆë‹¤.
                </p>
                <div id="monthlyLedgersContent">
                    </div>
            </div>

 
            <div id="goalAndStatsView" class="page-content" style="display: none;">

                <div class="goal-card card">
                    <h3 class="section-header" style="margin: 0 0 10px 0;
                        border-bottom: 1px solid var(--main-accent);">ë‚˜ì˜ ëª©í‘œ ì„¤ì •</h3>
                    
                    <textarea id="goalMemoInput" placeholder="ë‹¹ì‹ ì˜ ëª©í‘œë¥¼ ìì„¸íˆ ì‘ì„±í•´ë³´ì„¸ìš”.
                        (ì˜ˆ: 2026ë…„ê¹Œì§€ 5ì²œë§Œì› ëª¨ìœ¼ê¸°, ë¬´ì§€ì¶œ ì±Œë¦°ì§€ ë“±)"></textarea>

                    <div class="goal-actions">
                        <button id="saveGoalBtn">ëª©í‘œ ì €ì¥</button>
                        <button id="clearGoalBtn">ëª©í‘œ ì‚­ì œ</button>
                    </div>
 
                </div>

                <div class="stats-card card" id="fiveYearStats">
                    <h3 class="section-header" style="margin: 0 0 10px 0;
                        border-bottom: 1px solid var(--main-accent);">5ê°œë…„ ëˆ„ì  í†µê³„</h3>
                    <div id="fiveYearStatsContent">
                        <div class="empty-message" style="text-align: center;
                            color: #999; padding: 15px;">5ë…„ì¹˜ í†µê³„ ë°ì´í„°ë¥¼ ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤.</div>
                    </div>
                </div>
            </div>
            
        </div>
        
        <div class="global-actions" id="globalActions">
            <button id="globalResetBtn">âš ï¸ ëª¨ë“  ê¸°ë¡ ì´ˆê¸°í™” (ìµœê·¼ 5ë…„ ë°ì´í„° ì‚­ì œ)</button>
        </div>
        
     
        <div id="budgetModal" class="modal">
            <div class="modal-content">
                <span class="close-btn" id="modalCloseBtn">&times;</span>
                <h3>ê±°ë˜ ìˆ˜ì •/ë³´ê¸°</h3>
                
                <div class="modal-input-group">
              
                    <label>ë‚ ì§œ</label>
                    <input type="date" id="viewDate" required>
                </div>
                <div class="modal-input-group">
                    <label>ìœ í˜•</label>
                  
                    <select id="viewType" required>
                        <option value="expense">ì§€ì¶œ</option>
                        <option value="income">ìˆ˜ì…</option>
                    </select>
                </div>
          
                <div class="modal-input-group">
                    <label>ê¸ˆì•¡ (ì›)</label>
                    <input type="number" id="viewAmount" placeholder="ê¸ˆì•¡" required min="1">
                </div>
                <div class="modal-input-group">
              
                    <label>ì¹´í…Œê³ ë¦¬</label>
                    <select id="viewCategory" required>
                        </select>
                </div>
                <div class="modal-input-group">
               
                    <label>ë©”ëª¨</label>
                    <textarea id="viewMemo" placeholder="ë©”ëª¨"></textarea>
                </div>
                
                <div class="modal-actions">
                    <button id="modalSaveBtn">ìˆ˜ì • ì™„ë£Œ</button>
  
                    <button id="modalDeleteBtn">ì‚­ì œ</button>
                </div>
            </div>
        </div>

    </div>

<script>
// =========================================================================
// ğŸ§© JavaScript ë¡œì§ (BUDGET ì „ìš©) - V9 (ì´ˆê¸°í™” ë²„íŠ¼ 3í˜ì´ì§€ì—ë§Œ ì ìš©)
// =========================================================================

const db = new Dexie('BudgetAppDB');
db.version(2).stores({
    budgets: '++id, date, type, amount, category',
    goals: 'id', 
});

let dailyExpenseChartInstance = null;
let currentPage = 1;
const totalPages = 3;

// --- DOM ìš”ì†Œ ---
// ì…ë ¥
const budgetDateInput = document.getElementById('budgetDate');
const budgetTypeInput = document.getElementById('budgetType');
const budgetAmountInput = document.getElementById('budgetAmount');
const budgetCategoryInput = document.getElementById('budgetCategory');
const budgetMemoInput = document.getElementById('budgetMemo');
const saveBudgetBtn = document.getElementById('saveBudgetBtn');
// ì¶œë ¥/í†µê³„
const currentBalanceEl = document.getElementById('currentBalance');
const monthlyLedgersContentEl = document.getElementById('monthlyLedgersContent'); 
const fiveYearStatsContentEl = document.getElementById('fiveYearStatsContent');
const monthlyIncomeEl = document.getElementById('monthlyIncome');
const monthlyExpenseEl = document.getElementById('monthlyExpense');
const monthlyBalanceEl = document.getElementById('monthlyBalance');

// ëª©í‘œ ì„¤ì •
const goalMemoInputEl = document.getElementById('goalMemoInput');
const saveGoalBtn = document.getElementById('saveGoalBtn');
const clearGoalBtn = document.getElementById('clearGoalBtn');

// ëª©í‘œ ë³´ê¸° ëª¨ë“œì— ì‚¬ìš©ë  ìš”ì†Œë“¤ (DOMì— ì•„ì§ ì—†ëŠ” ìš”ì†ŒëŠ” JSì—ì„œ ìƒì„±)
const goalDisplayArea = document.createElement('div');
goalDisplayArea.id = 'goalDisplayArea';
goalDisplayArea.style.whiteSpace = 'pre-wrap';
goalDisplayArea.style.minHeight = '120px';
goalDisplayArea.style.padding = '12px';
goalDisplayArea.style.border = '1px solid #ccc';
goalDisplayArea.style.borderRadius = '8px';
goalDisplayArea.style.backgroundColor = '#f9f9f9';

const editGoalBtn = document.createElement('button');
editGoalBtn.id = 'editGoalBtn';
editGoalBtn.textContent = 'ëª©í‘œ ìˆ˜ì •';
editGoalBtn.style.backgroundColor = 'var(--main-accent)';
editGoalBtn.style.color = 'white';
editGoalBtn.style.padding = '12px 18px';
editGoalBtn.style.borderRadius = '8px';
editGoalBtn.style.fontWeight = 'bold';
editGoalBtn.style.cursor = 'pointer';
editGoalBtn.style.border = 'none';
// ì…ë ¥ ë‚´ìš© ì´ˆê¸°í™” ë²„íŠ¼ (JSì—ì„œ ìƒì„±)
const clearInputBtn = document.createElement('button');
clearInputBtn.id = 'clearInputBtn';
clearInputBtn.textContent = 'ì…ë ¥ ë‚´ìš© ë¹„ìš°ê¸°';
clearInputBtn.style.backgroundColor = '#999'; 
clearInputBtn.style.color = 'white';
clearInputBtn.style.padding = '12px 18px';
clearInputBtn.style.borderRadius = '8px';
clearInputBtn.style.fontWeight = 'bold';
clearInputBtn.style.cursor = 'pointer';
clearInputBtn.style.border = 'none';
clearInputBtn.style.marginLeft = '10px';


// ê¸°ì¡´ DOM êµ¬ì¡° ì°¸ì¡°
const goalCardBody = document.querySelector('.goal-card');
const goalActionsDiv = document.querySelector('.goal-actions');
// í˜ì´ì§€ë„¤ì´ì…˜
const pageIndicator = document.getElementById('pageIndicator');
const mainViewContainer = document.getElementById('mainViewContainer');
const prevPageBtn = document.getElementById('prevPageBtn');
const nextPageBtn = document.getElementById('nextPageBtn');
// ì „ì²´ ì´ˆê¸°í™” ë²„íŠ¼ ì»¨í…Œì´ë„ˆ (ì œì–´ ëŒ€ìƒ)
const globalActionsDiv = document.getElementById('globalActions');


const budgetModal = document.getElementById('budgetModal');
const modalCloseBtn = document.getElementById('modalCloseBtn');
const viewDateInput = document.getElementById('viewDate');
const viewTypeInput = document.getElementById('viewType');
const viewAmountInput = document.getElementById('viewAmount');
const viewCategoryInput = document.getElementById('viewCategory');
const viewMemoInput = document.getElementById('viewMemo');
const modalSaveBtn = document.getElementById('modalSaveBtn');
const modalDeleteBtn = document.getElementById('modalDeleteBtn');


let currentEditingId = null;
// ì¹´í…Œê³ ë¦¬ ëª©ë¡
const categories = {
    expense: [
        { value: 'ì‹ë¹„', label: 'ì‹ë¹„ ğŸ”' },
        { value: 'êµí†µ', label: 'êµí†µ ğŸšŒ' },
        { value: 'ì‡¼í•‘', label: 'ì‡¼í•‘ ğŸ›ï¸' },
        { value: 'ìƒí™œ', label: 'ìƒí™œ ğŸ ' },
        { value: 'ê²½ì¡°ì‚¬', label: 'ê²½ì¡°ì‚¬ ğŸ' },
        { value: 'ê¸°íƒ€_ì§€ì¶œ', label: 'ê¸°íƒ€ ì§€ì¶œ' }
    ],
    income: [
        { value: 'ì›”ê¸‰', label: 'ì›”ê¸‰ ğŸ’µ' },
        { value: 'ìš©ëˆ', label: 'ìš©ëˆ ğŸ’°' },
        { value: 'ë¶€ìˆ˜ì…', label: 'ë¶€ìˆ˜ì… âœ¨' },
        { value: 'ê¸°íƒ€_ìˆ˜ì…', label: 'ê¸°íƒ€ ìˆ˜ì…' }
    ]
};
// --- ìœ í‹¸ë¦¬í‹° ë° ì´ˆê¸°í™” í•¨ìˆ˜ ---
function getTodayDateString() {
    return new Date().toISOString().split('T')[0];
}

function formatAmount(amount) {
    return new Intl.NumberFormat('ko-KR').format(amount) + 'ì›';
}

function showToast(message) {
    console.log(`[Budget App] ${message}`);
}

function updateCategoryOptions(type, targetSelectElement) {
    targetSelectElement.innerHTML = '';
    const categoryList = categories[type] || categories.expense;
    categoryList.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.value;
        option.textContent = cat.label;
        targetSelectElement.appendChild(option);
    });
}

function clearInputFields() {
    budgetDateInput.value = getTodayDateString();
    budgetTypeInput.value = 'expense';
    budgetAmountInput.value = '';
    budgetMemoInput.value = '';
    updateCategoryOptions('expense', budgetCategoryInput);
}

// --- í˜ì´ì§€ë„¤ì´ì…˜ ë¡œì§ ---
function showPage(pageNumber) {
    currentPage = Math.min(Math.max(pageNumber, 1), totalPages); 
    
    document.querySelectorAll('.page-content').forEach(el => el.style.display = 'none');
    let targetView;
    switch (currentPage) {
        case 1: targetView = document.getElementById('recordView'); break;
        case 2: targetView = document.getElementById('monthlyLedgerView'); 
                renderMonthlyLedgersView(); 
                break;
        case 3: targetView = document.getElementById('goalAndStatsView'); 
                calculateFiveYearStats(); 
                loadGoal(); 
                break;
    }

    if (targetView) {
        targetView.style.display = 'block';
    }

    pageIndicator.textContent = `í˜ì´ì§€ ${currentPage} / ${totalPages}`;
    
    prevPageBtn.disabled = (currentPage === 1);
    nextPageBtn.disabled = (currentPage === totalPages);
    // âœ¨ í•µì‹¬ ìˆ˜ì •: 3í˜ì´ì§€ì¼ ë•Œë§Œ ì „ì²´ ì´ˆê¸°í™” ë²„íŠ¼ ë³´ì´ê¸°
    if (currentPage === 3) {
        globalActionsDiv.style.display = 'block';
    } else {
        globalActionsDiv.style.display = 'none';
    }
}


// -------------------------------------------------------------------------
// 1. ê±°ë˜ ê¸°ë¡ CRUD 
// -------------------------------------------------------------------------

async function saveBudget() {
    const date = budgetDateInput.value;
    const type = budgetTypeInput.value;
    const amount = parseInt(budgetAmountInput.value, 10);
    const category = budgetCategoryInput.value;
    const memo = budgetMemoInput.value.trim();
    const timestamp = new Date().getTime(); 

    if (!date || !type || !amount || !category || amount <= 0) {
        alert('í•„ìˆ˜ í•­ëª©ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”. ê¸ˆì•¡ì€ 1ì› ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        return;
    }
    
    try {
        await db.budgets.add({
            timestamp: timestamp,
            date: date,
            type: type, 
            amount: amount,
            category: category,
            memo: memo
        });
        showToast(`[${date}] ${type === 'income' ? 'ìˆ˜ì…' : 'ì§€ì¶œ'} ${formatAmount(amount)} ì €ì¥ ì™„ë£Œ.`);
        clearInputFields();
        refreshAllData();
    } catch (error) {
        showToast('ê±°ë˜ ê¸°ë¡ ì €ì¥ ì˜¤ë¥˜: ' + error);
        console.error("Save Budget Error:", error);
    }
}


async function saveModalBudget() {
    if (!currentEditingId) return;
    const id = currentEditingId;
    const date = viewDateInput.value;
    const type = viewTypeInput.value;
    const amount = parseInt(viewAmountInput.value, 10);
    const category = viewCategoryInput.value;
    const memo = viewMemoInput.value.trim();

    if (!date || !type || !amount || !category || amount <= 0) {
        alert('ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    try {
        const existingEntry = await db.budgets.get(id);
        await db.budgets.put({
            id: id,
            timestamp: existingEntry.timestamp,
            date: date,
            type: type,
            amount: amount,
            category: category,
            memo: memo
        });
        showToast(`ê±°ë˜ ê¸°ë¡ (ID: ${id}) ìˆ˜ì • ì™„ë£Œ.`);
        budgetModal.style.display = 'none';
        refreshAllData();
    } catch (error) {
        showToast('ê±°ë˜ ê¸°ë¡ ìˆ˜ì • ì˜¤ë¥˜: ' + error);
        console.error("Modal Save Error:", error);
    }
}

async function deleteBudgetEntry(id) {
    if (confirm('í•´ë‹¹ ê±°ë˜ ê¸°ë¡ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        try {
            await db.budgets.delete(id);
            showToast(`ê±°ë˜ ê¸°ë¡ (ID: ${id}) ì‚­ì œ ì™„ë£Œ`);
            budgetModal.style.display = 'none';
            refreshAllData();
        } catch (error) {
            showToast('ê±°ë˜ ê¸°ë¡ ì‚­ì œ ì˜¤ë¥˜: ' + error);
            console.error("Delete Budget Error:", error);
        }
    }
}

async function openBudgetModal(id) {
    currentEditingId = id;
    try {
        const entry = await db.budgets.get(id);
        if (!entry) {
            alert('ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        // ëª¨ë‹¬ì„ ì›ë˜ ì…ë ¥/ìˆ˜ì • ëª¨ë“œë¡œ ì¬ì„¤ì •
        const modalContent = document.getElementById('budgetModal').querySelector('.modal-content');
        modalContent.innerHTML = `
            <span class="close-btn" id="modalCloseBtn">&times;</span>
            <h3>ê±°ë˜ ìˆ˜ì •/ë³´ê¸°</h3>
            <div class="modal-input-group">
                <label>ë‚ ì§œ</label>
                <input type="date" id="viewDate" required>
            </div>
            <div class="modal-input-group">
                <label>ìœ í˜•</label>
                <select id="viewType" required>
                    <option value="expense">ì§€ì¶œ</option>
                    <option value="income">ìˆ˜ì…</option>
                </select>
            </div>
            <div class="modal-input-group">
                <label>ê¸ˆì•¡ (ì›)</label>
                <input type="number" id="viewAmount" placeholder="ê¸ˆì•¡" required min="1">
            </div>
            <div class="modal-input-group">
                <label>ì¹´í…Œê³ ë¦¬</label>
                <select id="viewCategory" required></select>
            </div>
            <div class="modal-input-group">
                <label>ë©”ëª¨</label>
                <textarea id="viewMemo" placeholder="ë©”ëª¨"></textarea>
            </div>
            <div class="modal-actions">
                <button id="modalSaveBtn">ìˆ˜ì • ì™„ë£Œ</button>
                <button id="modalDeleteBtn">ì‚­ì œ</button>
            </div>
        `;
        
        // ìƒˆë¡œ ìƒì„±ëœ DOM ìš”ì†Œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë‹¤ì‹œ ì—°ê²° (í•„ìš”í•œ ê²½ìš°)
        // ì—¬ê¸°ì„œëŠ” ìƒìœ„ ìŠ¤ì½”í”„ì˜ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë©°, ì‹¤ì œ DOM ìš”ì†Œë¥¼ ë‹¤ì‹œ ì°¾ì•„ì„œ ê°’ì„ ì„¤ì •í•©ë‹ˆë‹¤.
        const modalSaveBtn = modalContent.querySelector('#modalSaveBtn');
        const modalDeleteBtn = modalContent.querySelector('#modalDeleteBtn');
        const viewTypeInput = modalContent.querySelector('#viewType');
        
        modalContent.querySelector('#viewDate').value = entry.date;
        modalContent.querySelector('#viewType').value = entry.type;
        modalContent.querySelector('#viewAmount').value = entry.amount;
        modalContent.querySelector('#viewMemo').value = entry.memo || '';
        
        updateCategoryOptions(entry.type, modalContent.querySelector('#viewCategory'));
        modalContent.querySelector('#viewCategory').value = entry.category;

        modalSaveBtn.onclick = saveModalBudget;
        modalDeleteBtn.onclick = () => deleteBudgetEntry(entry.id);
        modalContent.querySelector('#modalCloseBtn').onclick = () => budgetModal.style.display = 'none';
        viewTypeInput.onchange = (e) => updateCategoryOptions(e.target.value, modalContent.querySelector('#viewCategory'));
        
        budgetModal.style.display = 'block';

    } catch (error) {
        showToast('ê±°ë˜ ê¸°ë¡ ë¡œë“œ ì˜¤ë¥˜: ' + error);
        console.error("Modal Load Error:", error);
    }
}

// -------------------------------------------------------------------------
// 2. í†µê³„ ë¡œì§
// -------------------------------------------------------------------------

function renderDailyExpenseChart(data, monthKey) {
    const ctx = document.getElementById('dailyExpenseChart').getContext('2d');
    const labels = Object.keys(data).sort();
    const expenditures = labels.map(day => data[day]);

    if (dailyExpenseChartInstance) {
        dailyExpenseChartInstance.destroy();
    }

    dailyExpenseChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels.map(date => date.substring(8) + 'ì¼'),
            datasets: [{
                label: `${monthKey} ì§€ì¶œ (ì¼ë³„)`,
                data: expenditures,
                backgroundColor: 'rgba(234, 67, 53, 0.8)', // expense-color
                borderColor: 'rgba(234, 67, 53, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            if (parseInt(value) >= 1000) {
                                return value.toLocaleString() + 'ì›';
                            }
                            return value + 'ì›';
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += formatAmount(context.parsed.y);
                            }
                            return label;
                        },
                        title: function(context) {
                            return context[0].label + ' ì§€ì¶œ';
                        }
                    }
                }
            }
        }
    });
}

async function calculateMonthlyStats() {
    const today = getTodayDateString();
    const currentMonthKey = today.substring(0, 7);
    const entries = await db.budgets
        .where('date').startsWith(currentMonthKey)
        .toArray();

    let income = 0;
    let expense = 0;
    const dailyExpense = {};

    for (let i = 1; i <= 31; i++) {
        const day = i < 10 ? '0' + i : String(i);
        dailyExpense[`${currentMonthKey}-${day}`] = 0;
    }

    entries.forEach(entry => {
        if (entry.type === 'income') {
            income += entry.amount;
        } else {
            expense += entry.amount;
            dailyExpense[entry.date] = (dailyExpense[entry.date] || 0) + entry.amount;
        }
    });

    const balance = income - expense;
    monthlyIncomeEl.textContent = `ìˆ˜ì…: ${formatAmount(income)}`;
    monthlyExpenseEl.textContent = `ì§€ì¶œ: ${formatAmount(expense)}`;
    monthlyBalanceEl.textContent = `ì”ì•¡: ${formatAmount(balance)}`;

    const validDailyExpense = Object.fromEntries(
        Object.entries(dailyExpense).filter(([key, value]) => value > 0 || key.substring(0, 7) === currentMonthKey)
    );
    renderDailyExpenseChart(validDailyExpense, currentMonthKey);
}

async function calculateBalance() {
    const allEntries = await db.budgets.toArray();
    let totalIncome = 0;
    let totalExpense = 0;

    allEntries.forEach(entry => {
        if (entry.type === 'income') {
            totalIncome += entry.amount;
        } else {
            totalExpense += entry.amount;
        }
    });

    const currentBalance = totalIncome - totalExpense;
    currentBalanceEl.textContent = formatAmount(currentBalance);
    if (currentBalance < 0) {
        currentBalanceEl.style.color = 'var(--expense-color)';
    } else {
        currentBalanceEl.style.color = 'var(--main-accent)';
    }
}

async function getGroupedMonthlyData(entries) {
    const grouped = {};
    entries.forEach(entry => {
        const monthKey = entry.date.substring(0, 7);
        if (!grouped[monthKey]) {
            grouped[monthKey] = { month: monthKey, income: 0, expense: 0, entries: [] };
        }
        if (entry.type === 'income') {
            grouped[monthKey].income += entry.amount;
        } else {
            grouped[monthKey].expense += entry.amount;
        }
        grouped[monthKey].entries.push(entry);
    });
    
    let sortedMonths = Object.values(grouped).sort((a, b) => b.month.localeCompare(a.month));
    sortedMonths.forEach(monthData => {
        monthData.entries.sort((a, b) => b.date.localeCompare(a.date));
    });
    return sortedMonths;
}


// ì›”ë³„ ì¥ë¶€ í†µê³„ë¥¼ í‘œ í˜•ì‹ìœ¼ë¡œ ë Œë”ë§ (í˜ì´ì§€ 2/3)
async function renderMonthlyLedgersView() {
    monthlyLedgersContentEl.innerHTML = '';
    const allEntries = await db.budgets.orderBy('date').reverse().toArray();

    if (allEntries.length === 0) {
        monthlyLedgersContentEl.innerHTML = '<div class="empty-message" style="text-align: center; color: #999; padding: 20px;">ê¸°ë¡ëœ ê±°ë˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    const monthlyData = await getGroupedMonthlyData(allEntries);
    let statsHTML = '';
    const yearlyGroups = {};

    monthlyData.forEach(monthData => {
        const year = monthData.month.substring(0, 4);
        if (!yearlyGroups[year]) {
            yearlyGroups[year] = [];
        }
        yearlyGroups[year].push(monthData);
    });

    const sortedYears = Object.keys(yearlyGroups).sort((a, b) => b.localeCompare(a));

    sortedYears.forEach(year => {
        const yearData = yearlyGroups[year];
        let yearIncome = 0;
        let yearExpense = 0;
        yearData.forEach(m => {
            yearIncome += m.income;
            yearExpense += m.expense;
        });
        const yearBalance = yearIncome - yearExpense;
        const yearBalanceColor = yearBalance < 0 ? 'var(--expense-color)' : 'var(--main-accent)';

        statsHTML += `
            <div class="monthly-stats-table-container">
                <div class="month-stat-title-header">${year}ë…„ ì—°ê°„ ìš”ì•½</div>
                <div class="month-summary">
                    <span class="income-text">ì´ ìˆ˜ì…: ${formatAmount(yearIncome)}</span>
                    <span class="expense-text">ì´ ì§€ì¶œ: ${formatAmount(yearExpense)}</span>
                    <span style="color: ${yearBalanceColor}; font-weight: bold;">ìˆœ ìì‚° ë³€í™”: ${formatAmount(yearBalance)}</span>
                </div>
                <table class="monthly-stats-table">
                    <thead>
                        <tr>
                            <th style="width:15%;">ì›”</th>
                            <th style="width:25%;">ì´ ìˆ˜ì…</th>
                            <th style="width:25%;">ì´ ì§€ì¶œ</th>
                            <th style="width:25%;">ìˆœ ìì‚° ë³€í™”</th>
                            <th style="width:15%;">ìƒì„¸ë³´ê¸°</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        yearData.sort((a, b) => b.month.localeCompare(a.month));
        yearData.forEach(monthData => {
            const monthBalance = monthData.income - monthData.expense;
            const balanceColor = monthBalance < 0 ? 'var(--expense-color)' : 'var(--income-color)';
            statsHTML += `
                <tr>
                    <td>${monthData.month.substring(5)}ì›”</td>
                    <td class="income-text">${formatAmount(monthData.income)}</td>
                    <td class="expense-text">${formatAmount(monthData.expense)}</td>
                    <td style="color: ${balanceColor}; font-weight: bold;">${formatAmount(monthBalance)}</td>
                    <td>
                        <button onclick="showMonthlyDetail('${monthData.month}')">ë³´ê¸°</button>
                    </td>
                </tr>
            `;
        });

        statsHTML += `
                    </tbody>
                </table>
            </div>
        `;
    });
    monthlyLedgersContentEl.innerHTML = statsHTML;
}

async function showMonthlyDetail(monthKey) {
    // ê¸°ì¡´ ëª¨ë‹¬ ë‹«ê¸°
    document.getElementById('budgetModal').style.display = 'none';

    const monthEntries = await db.budgets.where('date').startsWith(monthKey).reverse().toArray();
    let detailHtml = `<h3 style="text-align: center; color: var(--main-accent);">${monthKey} ìƒì„¸ ê¸°ë¡</h3>`;

    if (monthEntries.length === 0) {
        detailHtml += '<p style="text-align: center; color: #999;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    } else {
        detailHtml += `
            <table class="ledger-table" style="font-size: 0.9em; margin-top: 15px;">
                <thead>
                    <tr>
                        <th style="width:15%;">ë‚ ì§œ</th>
                        <th style="width:10%;">ìœ í˜•</th>
                        <th style="width:25%;">ê¸ˆì•¡</th>
                        <th style="width:20%;">ì¹´í…Œê³ ë¦¬</th>
                        <th style="width:20%;">ë©”ëª¨</th>
                        <th style="width:10%;">ìˆ˜ì •</th>
                    </tr>
                </thead>
                <tbody>
        `;
        monthEntries.forEach(entry => {
            const dateDay = entry.date.substring(8);
            const typeClass = entry.type;
            const sign = entry.type === 'income' ? '+' : '-';
            detailHtml += `
                <tr>
                    <td>${dateDay}ì¼</td>
                    <td class="${typeClass}">${entry.type === 'income' ? 'ìˆ˜ì…' : 'ì§€ì¶œ'}</td>
                    <td class="${typeClass}">${sign} ${formatAmount(entry.amount)}</td>
                    <td>${entry.category}</td>
                    <td>${entry.memo.substring(0, 10) + (entry.memo.length > 10 ? '...' : '')}</td>
                    <td class="action-cell">
                        <button onclick="openBudgetModal(${entry.id})">ìˆ˜ì •</button>
                    </td>
                </tr>
            `;
        });
        detailHtml += `
                </tbody>
            </table>
        `;
    }

    const originalModalContent = document.getElementById('budgetModal').querySelector('.modal-content');
    
    // ëª¨ë‹¬ì„ ìƒì„¸ ë³´ê¸° ëª¨ë“œë¡œ ì˜¤ë²„ë¼ì´ë“œ
    originalModalContent.innerHTML = `
        <span class="close-btn" onclick="document.getElementById('budgetModal').style.display = 'none'">&times;</span>
        ${detailHtml}
        <button style="float: right; margin-top: 10px; padding: 10px; background-color: #ccc; border-radius: 8px;"
            onclick="document.getElementById('budgetModal').style.display = 'none'">ë‹«ê¸°</button>
    `;
    document.getElementById('budgetModal').style.display = 'block';
}

// 5ê°œë…„ ë¯¸ë˜ í†µê³„ ë°˜ì˜ í•¨ìˆ˜
async function calculateFiveYearStats() {
    fiveYearStatsContentEl.innerHTML = '';
    const allEntries = await db.budgets.toArray();
    const currentYear = new Date().getFullYear();
    // í˜„ì¬ ì—°ë„ë¶€í„° +4ë…„ê¹Œì§€ (ì´ 5ê°œë…„)
    const endYear = currentYear + 4;

    const yearlyData = {};

    for (let year = currentYear; year <= endYear; year++) {
        yearlyData[year] = { income: 0, expense: 0, count: 0 };
    }

    allEntries.forEach(entry => {
        const year = new Date(entry.date).getFullYear();
        if (year >= currentYear && year <= endYear) {
            if (entry.type === 'income') {
                yearlyData[year].income += entry.amount;
            } else {
                yearlyData[year].expense += entry.amount;
            }
            yearlyData[year].count++;
        }
    });

    let statsHTML = '';
    
    for (let year = currentYear; year <= endYear; year++) {
        const data = yearlyData[year];
        const balance = data.income - data.expense;
        const balanceColor = balance < 0 ? 'var(--expense-color)' : 'var(--main-accent)';
        // í˜„ì¬ ì—°ë„ ì™¸ì˜ ë¯¸ë˜ ì—°ë„ì—ëŠ” ê¸°ë¡ì´ ì—†ìœ¼ë¯€ë¡œ '0ì›'ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
        statsHTML += `
            <div class="year-slot">
                <strong>${year}ë…„ ${year == currentYear ? 'ì‹¤ì ' : 'ê³„íš'}</strong>
                <p class="income-text">ì´ ìˆ˜ì…: ${formatAmount(data.income)}</p>
                <p class="expense-text">ì´ ì§€ì¶œ: ${formatAmount(data.expense)}</p>
                <p style="color: ${balanceColor}; font-weight: bold;">ìˆœ ìì‚° ë³€í™”: ${formatAmount(balance)}</p>
                <p style="font-size: 0.8em; color: #888;">(ì´ ${data.count} ê±´)</p>
            </div>
        `;
    }
    
    if (statsHTML === '') {
        fiveYearStatsContentEl.innerHTML = '<div class="empty-message" style="text-align: center; color: #999; padding: 15px;">5ë…„ì¹˜ í†µê³„ ë°ì´í„°ë¥¼ ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤.</div>';
    } else {
        fiveYearStatsContentEl.innerHTML = statsHTML;
    }
}

// -------------------------------------------------------------------------
// 3. ëª©í‘œ ì„¤ì • CRUD
// -------------------------------------------------------------------------

async function saveGoal() {
    const goalMemo = goalMemoInputEl.value.trim();
    if (!goalMemo) {
        alert('ëª©í‘œ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    try {
        await db.goals.put({ id: 1, memo: goalMemo });
        showToast('ëª©í‘œê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadGoal();
    } catch (error) {
        showToast('ëª©í‘œ ì €ì¥ ì˜¤ë¥˜: ' + error);
        console.error("Save Goal Error:", error);
    }
}

// ì…ë ¥ í•„ë“œë§Œ ë¹„ìš°ëŠ” í•¨ìˆ˜
function clearGoalInput() {
    goalMemoInputEl.value = '';
    showToast('ì…ë ¥ ë‚´ìš©ì´ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.');
}

function switchToEditMode() {
    // í…ìŠ¤íŠ¸ëŠ” inputì— ì €ì¥ë˜ì–´ ìˆìŒ
    goalDisplayArea.style.display = 'none';
    goalMemoInputEl.style.display = 'block';
    
    // ì•¡ì…˜ ë²„íŠ¼ ì „í™˜
    goalActionsDiv.innerHTML = '';
    goalActionsDiv.appendChild(clearInputBtn); // ì…ë ¥ ë‚´ìš© ë¹„ìš°ê¸° ë²„íŠ¼
    goalActionsDiv.appendChild(saveGoalBtn);
    
    showToast('ëª©í‘œ ìˆ˜ì • ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

async function loadGoal() {
    try {
        const goal = await db.goals.get(1);
        
        // goalDisplayAreaê°€ ì—†ìœ¼ë©´ ìƒì„±í•˜ì—¬ ì‚½ì…
        if (!goalCardBody.contains(goalDisplayArea)) {
            // saveGoalBtn, clearGoalBtnì˜ ë¶€ëª¨ ì—˜ë¦¬ë¨¼íŠ¸ì¸ goalActionsDivì˜ ì•ì— ì‚½ì…
            goalCardBody.insertBefore(goalDisplayArea, goalActionsDiv);
        }
        
        // ì•¡ì…˜ ë²„íŠ¼ ì´ˆê¸°í™”
        goalActionsDiv.innerHTML = '';

        if (goal && goal.memo) {
            // **ë³´ê¸° ëª¨ë“œ (ëª©í‘œê°€ ì„¤ì •ë˜ì–´ ìˆìŒ)**
            goalDisplayArea.textContent = goal.memo;
            goalDisplayArea.style.display = 'block';
            goalMemoInputEl.style.display = 'none';
            goalMemoInputEl.value = goal.memo; // ìˆ˜ì • ëª¨ë“œ ì „í™˜ ì‹œë¥¼ ìœ„í•´ ê°’ ì €ì¥
            
            // ë²„íŠ¼ ì¬ì„¤ì •
            goalActionsDiv.appendChild(editGoalBtn);
            goalActionsDiv.appendChild(clearGoalBtn);
            
            // ëª©í‘œ ì‚­ì œ (DB ì´ˆê¸°í™”)
            clearGoalBtn.textContent = 'ëª©í‘œ ì‚­ì œ'; // í…ìŠ¤íŠ¸ ìœ ì§€
            editGoalBtn.onclick = switchToEditMode;

        } else {
            // **í¸ì§‘ ëª¨ë“œ (ëª©í‘œê°€ ì—†ìŒ / ì²˜ìŒ ì‹œì‘)**
            goalDisplayArea.style.display = 'none';
            goalMemoInputEl.style.display = 'block';
            
            // ì…ë ¥ ë‚´ìš© ì´ˆê¸°í™” ë²„íŠ¼ ì¶”ê°€
            goalActionsDiv.appendChild(clearInputBtn);
            goalActionsDiv.appendChild(saveGoalBtn);

            // ì…ë ¥ ë‚´ìš© ë¹„ìš°ê¸° ë²„íŠ¼ í…ìŠ¤íŠ¸ ì„¤ì •
            clearInputBtn.textContent = 'ì…ë ¥ ë‚´ìš© ë¹„ìš°ê¸°';
            
            // ëª©í‘œê°€ ì—†ìœ¼ë©´ ì…ë ¥ í•„ë“œë¥¼ ë¹„ì›€ (ì¬ë¡œë“œ ì‹œ ê°’ ìœ ì§€ ë°©ì§€)
            if (goalMemoInputEl.value === goalMemoInputEl.placeholder.split('\n')[0]) {
                 goalMemoInputEl.value = '';
            }
        }
    } catch (error) {
        showToast('ëª©í‘œ ë¡œë“œ ì˜¤ë¥˜: ' + error);
        console.error("Load Goal Error:", error);
    }
}

async function clearGoal() {
    if (confirm('í˜„ì¬ ì„¤ì •ëœ ëª©í‘œ ë‚´ìš©ì„ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        try {
            await db.goals.clear();
            showToast('ëª©í‘œ ì„¤ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            goalMemoInputEl.value = ''; // í•„ë“œë„ ë¹„ì›€
            loadGoal(); // ìƒíƒœ ì—…ë°ì´íŠ¸
        } catch (error) {
            showToast('ëª©í‘œ ì‚­ì œ ì˜¤ë¥˜: ' + error);
            console.error("Clear Goal Error:", error);
        }
    }
}

async function clearAllRecords() {
    if (confirm('âš ï¸ ê²½ê³ : ëª¨ë“  ê°€ê³„ë¶€ ê¸°ë¡ (ìµœê·¼ 5ë…„ ë°ì´í„° í¬í•¨) ë° ëª©í‘œ ì„¤ì •ì´ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        try {
            await db.budgets.clear();
            await db.goals.clear();
            showToast('ëª¨ë“  ê°€ê³„ë¶€ ê¸°ë¡ ë° ëª©í‘œ ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            clearInputFields();
            refreshAllData();
        } catch (error) {
            showToast('ì „ì²´ ì´ˆê¸°í™” ì˜¤ë¥˜: ' + error);
            console.error("Global Reset Error:", error);
        }
    }
}

// --- ì „ì—­ ì—…ë°ì´íŠ¸ ë° ì´ˆê¸°í™” ---
function refreshAllData() {
    calculateBalance();
    calculateMonthlyStats();
    if (currentPage === 2) renderMonthlyLedgersView();
    if (currentPage === 3) {
        calculateFiveYearStats();
        loadGoal();
    }
}

function initializeApp() {
    clearInputFields();
    showPage(1);
    refreshAllData();

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    saveBudgetBtn.addEventListener('click', saveBudget);
    budgetTypeInput.addEventListener('change', (e) => updateCategoryOptions(e.target.value, budgetCategoryInput));

    // ëª©í‘œ ì„¤ì • ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ
    saveGoalBtn.addEventListener('click', saveGoal);
    clearGoalBtn.addEventListener('click', clearGoal);
    clearInputBtn.addEventListener('click', clearGoalInput); 
    
    // editGoalBtn ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ 
    editGoalBtn.addEventListener('click', switchToEditMode);
    
    // ì „ì²´ ì´ˆê¸°í™” ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('globalResetBtn').addEventListener('click', clearAllRecords);
    
    // í˜ì´ì§€ë„¤ì´ì…˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    prevPageBtn.addEventListener('click', () => showPage(currentPage - 1));
    nextPageBtn.addEventListener('click', () => showPage(currentPage + 1));
    
    // ëª¨ë‹¬ ì´ë²¤íŠ¸
    modalCloseBtn.onclick = () => budgetModal.style.display = 'none';
    window.onclick = function(event) {
        if (event.target == budgetModal) {
            budgetModal.style.display = 'none';
        }
    }
    
    viewTypeInput.addEventListener('change', (e) => updateCategoryOptions(e.target.value, viewCategoryInput));
    
    modalSaveBtn.addEventListener('click', saveModalBudget);
    modalDeleteBtn.addEventListener('click', () => deleteBudgetEntry(currentEditingId));
}

// ì´ˆê¸°í™” í˜¸ì¶œ
initializeApp();

// Global Functions for inline onclick (due to showMonthlyDetail dynamically changing modal content)
window.showMonthlyDetail = showMonthlyDetail;
window.openBudgetModal = openBudgetModal;
window.saveModalBudget = saveModalBudget;
window.deleteBudgetEntry = deleteBudgetEntry;
window.clearAllRecords = clearAllRecords; // For global reset button

</script>
</body>
</html>